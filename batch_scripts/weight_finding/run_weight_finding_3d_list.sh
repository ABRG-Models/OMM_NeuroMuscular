#!/bin/sh
#$ -l mem=1G
#$ -l rmem=1G
#$ -l h_rt=127:59:00
#$ -m ae
#$ -M seb.james@sheffield.ac.uk

# Things to check before running:
# Is the luminance file correctly written out?
# Are there any extra params to go in the convert_script_s2b call in run_simulation_multi.m?
# Is the correct explicitDataBinaryFileN.bin being written into?

# Simultaneously run the weight finding algorithm for all the eccentricities of interest:

PARENT_LIMIT=28

MIN_RAD=6
MAX_RAD=22.5

echo "$0 - Theta X range: list; Theta Y range: list" >> ~/fast/allweights.log
echo "explicitDataBinaryFileN.bin: L:50 R:52 U:53 D:54 Z+:58 Z-:57" >> ~/fast/allweights.log
echo -n "Start date: "
date >> ~/fast/allweights.log

#RX-15RY6 etc etc. Create this list with find_missing.sh
LIST="RX0RY7 RX-10RY10 RX-10RY-11 RX-10RY-12 RX-10RY12 RX-10RY13 RX-10RY-14 RX-10RY14 RX-10RY-15 RX-10RY15 RX-10RY-16 RX-10RY16 RX-10RY-17 RX-10RY17 RX-10RY-18 RX-10RY18 RX-10RY-19 RX-10RY19 RX-10RY-1 RX-10RY1 RX10RY1 RX-10RY-20 RX-10RY20 RX10RY-20 RX-10RY-2 RX-10RY2 RX-10RY-3 RX-10RY-4 RX-10RY-5 RX-10RY5 RX-10RY6 RX-10RY7 RX-10RY-8 RX-10RY8 RX-10RY-9 RX-10RY9 RX-11RY-10 RX-11RY10 RX-11RY11 RX-11RY-12 RX-11RY12 RX-11RY13 RX-11RY-14 RX-11RY14 RX-11RY15 RX-11RY-16 RX-11RY-17 RX-11RY17 RX-11RY-18 RX-11RY18 RX-11RY-19 RX-11RY19 RX-11RY-1 RX-11RY1 RX11RY1 RX-11RY2 RX-11RY-3 RX-11RY4 RX-11RY5 RX-11RY6 RX-11RY7 RX-11RY8 RX-11RY9 RX-12RY13 RX-12RY14 RX-12RY15 RX-12RY-16 RX-12RY16 RX-12RY17 RX-12RY18 RX-12RY1 RX12RY1 RX-12RY-3 RX-12RY4 RX-12RY5 RX-12RY9 RX-13RY1 RX13RY1 RX-13RY-9 RX-14RY11 RX14RY11 RX14RY12 RX14RY13 RX14RY14 RX14RY15 RX14RY16 RX14RY-17 RX-14RY1 RX14RY1 RX15RY-10 RX15RY10 RX15RY-11 RX15RY-12 RX15RY-13 RX15RY-14 RX15RY-15 RX-15RY1 RX15RY1 RX-15RY-2 RX15RY-4 RX15RY-7 RX15RY-8 RX15RY-9 RX-16RY-10 RX-16RY-12 RX-16RY-1 RX-16RY1 RX16RY1 RX-16RY-6 RX-16RY-9 RX-16RY9 RX17RY-13 RX-17RY1 RX17RY1 RX-17RY-2 RX-17RY2 RX17RY2 RX-18RY1 RX18RY1 RX-18RY2 RX18RY2 RX18RY8 RX18RY-9 RX18RY9 RX19RY-11 RX19RY11 RX19RY-12 RX-19RY1 RX19RY1 RX-19RY2 RX19RY2 RX-19RY-8 RX1RY-10 RX-1RY17 RX-1RY20 RX1RY20 RX-1RY-9 RX-20RY1 RX20RY1 RX-20RY2 RX20RY2 RX-21RY-1 RX-21RY1 RX21RY1 RX-21RY2 RX21RY2 RX-22RY-1 RX-22RY1 RX22RY1 RX-22RY2 RX22RY2 RX-2RY10 RX-2RY11 RX-2RY12 RX-2RY15 RX2RY16 RX-2RY-20 RX-2RY-21 RX-2RY-22 RX-2RY-7 RX-2RY7 RX-3RY-10 RX-3RY10 RX-3RY11 RX-3RY-12 RX-3RY12 RX-3RY-13 RX-3RY14 RX-3RY15 RX-3RY16 RX-3RY-17 RX-3RY17 RX-3RY18 RX-3RY-19 RX-3RY19 RX-3RY-20 RX-3RY20 RX-3RY-21 RX-3RY21 RX-3RY-22 RX-3RY22 RX-3RY-6 RX-3RY6 RX-3RY-7 RX-3RY7 RX-3RY-8 RX-3RY8 RX-3RY9 RX-4RY-10 RX-4RY10 RX-4RY-11 RX-4RY11 RX-4RY12 RX-4RY13 RX-4RY14 RX-4RY-15 RX-4RY-16 RX-4RY16 RX-4RY17 RX-4RY-18 RX-4RY18 RX-4RY-19 RX-4RY19 RX-4RY-20 RX-4RY20 RX-4RY-21 RX-4RY21 RX-4RY-22 RX-4RY22 RX-4RY-5 RX-4RY5 RX-4RY-6 RX-4RY-7 RX-4RY7 RX-4RY8 RX-4RY-9 RX-5RY-10 RX-5RY11 RX-5RY-12 RX-5RY12 RX-5RY-13 RX-5RY13 RX-5RY-14 RX-5RY14 RX-5RY-15 RX-5RY15 RX-5RY16 RX-5RY17 RX-5RY18 RX-5RY-19 RX-5RY19 RX-5RY20 RX-5RY-21 RX-5RY21 RX5RY-21 RX-5RY-4 RX-5RY5 RX-5RY7 RX-5RY-8 RX-5RY8 RX-5RY-9 RX-5RY9 RX-6RY0 RX-6RY-10 RX-6RY10 RX-6RY-11 RX6RY-11 RX6RY-12 RX-6RY-13 RX-6RY15 RX-6RY-16 RX6RY-16 RX6RY16 RX-6RY-17 RX-6RY17 RX-6RY-18 RX-6RY18 RX-6RY-19 RX-6RY-20 RX-6RY20 RX-6RY21 RX-6RY2 RX-6RY4 RX-6RY-5 RX-6RY-6 RX6RY-6 RX-6RY-8 RX-6RY-9 RX-6RY9 RX-7RY12 RX7RY12 RX-7RY16 RX-7RY17 RX7RY-1 RX-7RY20 RX-7RY21 RX-7RY2 RX-7RY4 RX-7RY-5 RX-7RY5 RX-8RY0 RX-8RY10 RX-8RY11 RX-8RY-12 RX-8RY-13 RX-8RY13 RX-8RY14 RX-8RY-15 RX-8RY15 RX-8RY-17 RX-8RY17 RX-8RY-18 RX-8RY-19 RX-8RY-1 RX-8RY1 RX-8RY-20 RX-8RY-21 RX-8RY2 RX-8RY-3 RX-8RY3 RX-8RY-4 RX-8RY4 RX-8RY-5 RX-8RY5 RX-8RY7 RX-8RY-9 RX-8RY9 RX-9RY0 RX-9RY-10 RX-9RY-11 RX-9RY-12 RX-9RY13 RX-9RY14 RX-9RY-15 RX-9RY15 RX-9RY-16 RX-9RY16 RX-9RY-17 RX-9RY17 RX-9RY-18 RX-9RY18 RX-9RY19 RX-9RY-1 RX-9RY20 RX-9RY-4 RX-9RY5 RX-9RY-7 RX-9RY7 RX-9RY8 RX-9RY-9 RX-9RY9"

# I'm going to have to add jobs and monitor them and keep only about
# PARENT_LIMIT of these jobs running at once, otherwise I'll run out
# of available hosts to run the "worker" jobs (those which actually
# run the simulation).
for tag in $LIST; do

    # while num jobs of this type > 10, wait...
    NUM_PARENTS=`qstat -u pc1ssj | grep RX | wc -l`
    while [ $NUM_PARENTS -gt $PARENT_LIMIT ]; do
        sleep 15
        NUM_PARENTS=`qstat -u pc1ssj | grep RX | wc -l`
    done

    x=`echo $tag | awk -F 'R' '{print $2}' | tr --delete "X"`
    y=`echo $tag | awk -F 'R' '{print $3}' | tr --delete "Y"`

    #echo "qsub $tag: $x, $y"
    # Now we can add another one...
    qsub -P insigneo-notremor -N ${tag} \
        -o /fastdata/pc1ssj/rwf3dmany${tag}.out -j y \
        ./run_weight_finding_3d.sh "$x" "$y" 0.8
done
